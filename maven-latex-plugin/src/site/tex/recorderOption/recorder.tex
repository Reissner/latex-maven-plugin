\RequirePackage[l2tabu, orthodox]{nag}
\documentclass[a4paper]{article}

\synctex=1
\usepackage{iftex}

\iftutex%
  \usepackage{fontspec}
\else
  \usepackage[utf8]{inputenc}
  \usepackage[T1]{fontenc}
\fi

\usepackage{ifthen}
\newboolean{texFhtLoaded}
\setboolean{texFhtLoaded}{false}

% absolutely necessary. 
% for document development add certain options. 
% Then remove headline and prevent this plugin from overwriting. 
\usepackage[a4paper]{geometry}% option , showframe, showcrop 
%\usepackage{showframe} as an alternative 
\usepackage{microtype}
% special characters
\usepackage{textcomp}
%\usepackage{anyfontsize}
%\usepackage{cleveref}


% used by hyperref and also to update index and glossary 
% to avoid clash because of loading with different options: 
% declare first 
\usepackage[aux]{rerunfilecheck}




\ifpdf%
  \usepackage[destlabel]{hyperref}
\else
  \ifXeTeX%
    \usepackage{hyperref}
  \else
    \usepackage[dvipdfmx, destlabel]{hyperref}
    % lualatex: without [dvipdfmx] option did not find converter dvi to pdf or to ps
    % pdflatex: without [dvipdfmx] option dvips still works, but no converter for pdf
    % with [dvipdfmx] all works fine 
  \fi%
\fi%ifpdf

\usepackage{import}
\usepackage{amsmath}

% synchronization between tex and pdf 
%\usepackage[active]{srcltx}
\usepackage{longtable}
\usepackage{listings}
% this is a workaround for including listings with latexmk.. 
% This can be fixed 
% - as shown below 
% - patch in package listings 
% - patch in latexmk 
% I would prefer the latter. 
\usepackage{xpatch}
\makeatletter
\newcommand*{\NewLine}{^^J}%
\xpatchcmd{\lst@MissingFileError}
{Package Listings Error: File `#1(.#2)' not found.}
{LaTeX Error: File `#1.#2' not found.\NewLine}{%
  \typeout{File ending patch for \string\lst@MissingFileError\space done.}%
}{%
  \typeout{File ending patch for \string\lst@MissingFileError\space failed.}%
}
\makeatother

\usepackage{fancyvrb}


% index and glossary
\ifthenelse{\boolean{texFhtLoaded}}{%
  \newcommand{\pkg}[1]{\texttt{#1}}% without indexing 
}{
  \usepackage{splitidx}%[split]
%  \usepackage{makeidx}
%  \usepackage{showidx}
  \makeindex
  \usepackage[toc]{glossaries}%,automake
  % , xindy or even [xindy={language=english,codepage=utf8}]
  % mainly for index and glossaries 
  %\makeglossaries% TBD: activate later
  \newcommand{\pkg}[1]{\texttt{#1}\sindex[pkg]{#1}} % TBD: this must be extracted 
  }

% high quality tables 
\usepackage{booktabs}
\aboverulesep=0ex
\belowrulesep=0ex

\usepackage[nottoc, numindex, numbib]{tocbibind}

\ifpdf%=
  \ifLuaTeX%
    % for lualatex
    \pdfvariable minorversion=7% chktex 1
    % omit CreationDate and ModDate keys.
    \pdfvariable suppressoptionalinfo 767% chktex 1
    % no adding to the trailer dictionary.
    \pdfvariable trailerid{}% chktex 1
    \pdfvariable suppressoptionalinfo -1% chktex 1
  \else
    \ifXeTeX%
      % for xelatex
      \special{pdf:minorversion 7}
      % TBD: find a way to express pdfinfoomitdate: necessary? 
      \special{pdf:trailerid []}
    \else
      \ifPDFTeX%  
        \pdfminorversion=7         % for pdflatex
        % omit CreationDate and ModDate keys.
        % not before pdfTeX 3.14159265-2.6-1.40.17
        \pdfinfoomitdate=1                   % for pdflatex
        % no adding to the trailer dictionary.
        %\pdftrailer=0                        % for pdflatex
        \pdftrailerid{}                       % for pdflatex
        \pdfsuppressptexinfo=-1               % for pdflatex
      \else
        % Here, the tex processor is unknown. 
      \fi%pdftex
    \fi%xetex
  \fi%luatex

  \hypersetup{
    pdfinfo={
      Author      ={Ernst Reissner},
      Title       ={The recorder option for latex processors and its applications},
      CreationDate={unknown},
      ModDate     ={unknown},
      Producer    ={unknown},
      Subject     ={dependency management in latex documents},
      Keywords    ={LaTeX;latexmk}
    }
  }
\else
\fi%ifpdf


\title{The recorder option for latex processors and its applications}

\author{Ernst Rei√üner}
\date{}

\begin{document}

\maketitle
\tableofcontents

\section{Introduction}\label{sec:intro}

This document is about the \texttt{recorder} option available for all modern \LaTeX{} processors, 
among those also \texttt{lualatex}. 
If the \LaTeX{} processor is applied to a file \texttt{xxx.tex} with this option set, 
it writes a file \texttt{xxx.fls} in the FLS format 
which is described in Section~\ref{sec:format}. 
Essentially, it contains dependency information for that file 
which can be used to decide on rebuilding the document. 
This is mostly to spare processing time 
while still ensuring that the created documents are up-to-date. 
Among others, \texttt{latexmk} uses this information. 

Another possible use case for the FLS files is to ensure reprocucibility of the results. 
The FLS file can be the main contribution to this: 
Essentially for reproduction all the input files mentioned in the FLS file 
must be the delivered to reproduce the results. 

Part is in the installation so if this is known, 
only the files mentioned in the FLS file as input which are outside the installation must be delivered. 
CAUTION\@: There are packages not part of an installation 
but installed separately fitting into the folder structure of the installation 
like the tikz uml package described in~\cite{tikzumlP} at time of this writing. 

To get all creates files all files mentioned in the FLS file as output must be delivered. 
\medskip


The problem with the FLS files is, 
that no official information on the FLS format seems available 
and so there is no way but reverse engineering. 

The risk to have an incomplete specification is always present, 
also that the format is updated and the reverse engineered specification is rendered invalid. 
Thus, software based on this specification must be failure tolerant. 
The goal that the result of running this software is perfect if no warning is displayed 
implies that, the parser for FLS files emits a warning for small deviations from the expected 
still tolerating these deviations. 

Another problem is, that seemingly the list given by the FLS files 
is not complete. 
Some gaps are spotted in Section~\ref{sec:gaps}


\section{The FLS format}\label{sec:format}

The FLS format seems to be line based and so is the description. 
The format is described in terms of the possible form of lines. 

In addition, the form of a line is quite restricted. 
It is of the form \texttt{type file}, consisting of line type and a file path. 
The available \texttt{type}s are 
%
\begin{description}
  \item[PWD] The working folder. 
  Seemingly this is the folder containing the latex file \texttt{xxx.tex} to be processed. 
  This type of line occurs once and is the first line. 
  We refer to it as the \emph{current directory}. 
  \item[INPUT] Intentionally all input files. Among those \texttt{xxx.tex}, \texttt{xxx.aux}, 
  Possibly graphic files and files related with fonts. 
  \item[OUTPUT] Intentionally all output files. 
  Among those \texttt{xxx.log}, \texttt{xxx.tex}, \texttt{xxx.pdf}
  but also very strange cache files. 
  Note that \texttt{xxx.fls} itself and also the file \texttt{xxx.synctex.gz} are not mentioned. 
  Maybe there are more files not mentioned. 
\end{description}

The line \texttt{PWD} is first and there is a single one specifying the working folder. 
Paths are not restricted to the local folder but may point also into the latex installation. 
Paths may be absolute and relative. 
Relative paths seem to be relative to the working folder. 
TBD\@: do research on paths with blanks. 

Note that a file may occur as input and output like \texttt{xxx.aux}. 

The relative paths either start with \texttt{./} or with \texttt{../}. 
In the first case, it seems that these paths refer to files in a subdirectory 
of the current directory, not in the second. 

The absolute paths either refer to the installation or to a cache. 
In my linux box, the cache is at \texttt{~/.cache/texmf/}, so it is in my home directory. 

The installation directory of a \TeX{} Live installation, 
is given by \texttt{kpsewhich latex.ltx}, 
just eliminating three containment levels from the path. 

The rest of the input lines of the fls files are the following on my linux box: 
%
\begin{verbatim}
INPUT /var/lib/texmf/web2c/luahbtex/lualatex.fmt
INPUT /var/lib/texmf/fonts/map/pdftex/updmap/pdftex.map
INPUT /etc/texmf/web2c/mktex.cnf
\end{verbatim}

\section{Gaps}\label{sec:gaps}

The FSL file itself is not among the outputs mentioned, 
which may be intentional as this information is redundant. 
Besides this, the only examples without loading packages, 
the author knows about at time of this writing 
are the file \texttt{xxx.synctex.gz} and related. 
In general, each package is responsible for keeping track of its file input and output. 
So to ensure that the input and output files mentioned in the FLS file, 
it is advisable to restrict oneself to a liminted set of packages. 

If FIG files are used then as mentioned in~\cite{XFigF}, Section 3.2, 
also pictures can be included. 
Some of the supported formats allow even inclusion of further files. 

Metapost files, described in~\cite{MPost} also offer a way to include other files. 
Also the processor for metapost, \texttt{mpost} offers its own \texttt{recorder} option 
as indicated in~\cite{MPost},~Appendix~B~2.1. 
Note that also \texttt{luatex} can be used as a metapost processor 
and it should be checked which of the dependencies within metapost files 
\texttt{luatex} records within its FLS file. 

Strange enough, nowhere in the manual~\cite{MPost} 
is introduced the probably most relevant way of including other metapost files, 
namely by the command \texttt{input}, 
although Section~13.1 uses this mechanism to include \texttt{TEX.mp}. 
There is a separate Section~12 on reading and writing files, 
which mention the commands \texttt{readfrom}, \texttt{closefrom} 
and \texttt{write}\dots\texttt{to}. 

Besides this, there is a more hidden way to include files, 
because between \texttt{btex} or \texttt{verbatimtex} and \texttt{etex} 
can be placed arbitrary \TeX{} material 
and in particular the \texttt{\textbackslash{}input} macro to include further TEX files. 

For \texttt{lualatex},~\cite{LuaInMp}, 
Section~``Helpers'' illustrates that lua code can be directly invoked within matapost. 
Of course, lua can access files, possibly reading or writing, and it is hardly conceivable, 
that the files seen or touched are recorded. 

The author did not check for any of these constructions which may introduce dependencies, 
which of all these dependencies are taken into account, 
in the FLS file created by \texttt{mpost} with given \texttt{recorder} option. 

Besides running an external metapost processor, 
the package \texttt{luamplib} available for \texttt{lualatex} (see~\cite{LuaMpLib})
can include metapost files or metapost code directly. 
This offers the chance 
to include the dependencies not in an ``external'' FLS file of the metapost file
but directly in the FLS file of the processed latex file. 

In older versions of \texttt{luamplib} 
even metapost files included with the command \texttt{input <file>;} 
where not recorded in the FLS file. 

Maybe there are more files not mentioned. 



\bibliographystyle{alpha}
\bibliography{../lit}{}% chktex 11 

\end{document}